/*
 * * Sources from Qualys Security Advisory CVE-2015-0235
 * * More information at: https://community.qualys.com/blogs/laws-of-vulnerabilities/2015/01/27/the-ghost-vulnerability
 * * Original sources can be found in (section [ 4 - Case studies ]) at: https://www.qualys.com/research/security-advisories/GHOST-CVE-2015-0235.txt
 * *
 * */

#include <netdb.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <errno.h>

#define CANARY "in_the_coal_mine"

struct {
	char buffer[1024];
	char canary[sizeof(CANARY)];
} temp = { "buffer", CANARY };

int main(void) {
	struct hostent resbuf;
	struct hostent *result;
	int herrno;
	int retval;

	/*** strlen (name) = size_needed - sizeof (*host_addr) - sizeof (*h_addr_ptrs) - 1; ***/
	size_t len = sizeof(temp.buffer) - 16*sizeof(unsigned char) - 2*sizeof(char *) - 1;
	char name[sizeof(temp.buffer)];
	memset(name, '0', len);
	name[len] = '\0';

	retval = gethostbyname_r(name, &resbuf, temp.buffer, sizeof(temp.buffer), &result, &herrno);

	if (strcmp(temp.canary, CANARY) != 0) {
		puts("\033[31mThis system is vulnerable to GHOST CVE-2015-0235, GLIBC must be updated with a fixed version\033[0m");
		exit(EXIT_FAILURE);
	}
	if (retval == ERANGE) {
		puts("\033[32mThis system is not vulnerable to GHOST CVE-2015-0235\033[0m");
		exit(EXIT_SUCCESS);
	}
	puts("\033[32mError cannot check GHOST vulnerability\033[0m");
	exit(EXIT_FAILURE);
}

